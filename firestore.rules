rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    function isSignedIn() { 
      return request.auth != null; 
    }
    
    function uid() { 
      return request.auth.uid; 
    }

    function isAdmin() {
      // Robust admin check: check Custom Claims (fastest/safest) OR Firestore Doc (backup)
      // We handle case-insensitive "admin" and "administrador"
      return isSignedIn() && (
        request.auth.token.admin == true ||
        (request.auth.token.get('role', '').lower() in ['admin', 'administrador']) ||
        (exists(/databases/$(database)/documents/users/$(uid())) && 
         get(/databases/$(database)/documents/users/$(uid())).data.get('role', 'student').lower() in ['admin', 'administrador'])
      );
    }

    function isEnrollmentActive(courseId) {
      let path = /databases/$(database)/documents/enrollments/$(uid() + '_' + courseId);
      if (!exists(path)) { return false; }
      let enrollment = get(path).data;
      
      let statusValid = enrollment.status in ['active', 'completed'];
      let timeValid = enrollment.get('paymentMethod', '') != 'subscription' 
                    || enrollment.get('accessUntil', request.time) >= request.time;
      
      return statusValid && timeValid;
    }

    function isCoursePublished(courseId) {
      let path = /databases/$(database)/documents/courses/$(courseId);
      if (!exists(path)) { return false; }
      let course = get(path).data;
      return course.isPublished == true && course.status == 'open';
    }

    function canAccessContent(courseId) {
      return isAdmin() || isTeam(courseId) || (isEnrollmentActive(courseId) && isCoursePublished(courseId));
    }

    function isTeam(courseId) {
      return exists(/databases/$(database)/documents/courses/$(courseId)/team/$(uid()));
    }

    // --- Collections ---

    // USERS (Strict Privacy)
    match /users/{userId} {
      allow read: if isAdmin() || (isSignedIn() && userId == uid());
      allow create: if isSignedIn() && userId == uid();
      // Allow users to update their own profile, but NOT their role
      allow update: if isAdmin() || (isSignedIn() && userId == uid() && !("role" in request.resource.data));
    }

    // APPLICATIONS (Interessados)
    match /applications/{appId} {
      allow read, write: if isAdmin();
      allow create: if true; // Public lead capture
    }

    // COURSES (Catalog & Content)
    match /courses/{courseId} {
      // Read: Public/Open OR Authorized OR Admin/Team
      allow read: if canAccessContent(courseId) || resource.data.status == 'open'; 
      allow write: if isAdmin() || isTeam(courseId);

      // Subcollections inherit logic but specific rules apply
      match /modules/{moduleId} {
        allow read: if canAccessContent(courseId);
        allow write: if isAdmin() || isTeam(courseId);

        match /lessons/{lessonId} {
          allow read: if canAccessContent(courseId);
          allow write: if isAdmin() || isTeam(courseId);

          match /blocks/{blockId} {
              allow read: if canAccessContent(courseId);
              allow write: if isAdmin() || isTeam(courseId);
          }
        }
      }

      match /materials/{materialId} {
        allow read: if isAdmin() || isTeam(courseId) || isEnrolled(courseId);
        allow write: if isAdmin() || isTeam(courseId);
      }

      match /announcements/{announcementId} {
        allow read: if isAdmin() || isTeam(courseId) || isEnrolled(courseId);
        allow write: if isAdmin() || isTeam(courseId);
      }

      // Community Subcollection (Preferred approach)
      match /communityThreads/{threadId} {
        allow read: if isAdmin() || isTeam(courseId) || isEnrolled(courseId);
        allow create: if isEnrolled(courseId);
        allow update: if (isAdmin() || isTeam(courseId)) || (isSignedIn() && request.resource.data.authorId == uid() && resource.data.authorId == uid() && !("isPinned" in request.resource.data) && !("isLocked" in request.resource.data));
        allow delete: if isAdmin() || isTeam(courseId); // Soft delete preferred via update

        match /replies/{replyId} {
          allow read: if isAdmin() || isTeam(courseId) || isEnrolled(courseId);
          allow create: if isEnrolled(courseId);
          allow update: if (isAdmin() || isTeam(courseId)) || (isSignedIn() && request.resource.data.authorId == uid());
          allow delete: if isAdmin() || isTeam(courseId);
        }
      }

      match /team/{memberId} {
        allow read: if isAdmin() || isTeam(courseId);
        allow write: if isAdmin() || isTeam(courseId);
      }
    }

    // GLOBAL ENROLLMENTS (The Ledger)
    match /enrollments/{enrollmentId} {
      // ID scheme: {uid}_{courseId}
      allow read: if isAdmin() || (isSignedIn() && resource.data.userId == uid());
      allow write: if isAdmin(); // System/Admin managed
    }

    // GLOBAL PROGRESS
    match /progress/{progressId} {
      // ID scheme: {uid}_{courseId}
      // Allow read if admin, or doc doesn't exist (to allow 404), or it belongs to user
      allow read: if isSignedIn() && (
        isAdmin() || 
        resource == null || 
        resource.data.userId == uid() || 
        isTeam(resource.data.courseId)
      );
      
      // WRITE SECURITY: All progress updates MUST go through Server Actions
      // to ensure enrollment validation and business logic.
      allow write: if false; 
    }

    // GLOBAL CERTIFICATES
    match /certificates/{certificateId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.userId == uid());
      allow write: if isAdmin(); // Server issued
    }
    
    // EVENTS (Live Sessions)
    match /events/{eventId} {
         // Allow reading any event metadata for signed in users
         // (Required for general agenda queries)
         allow read: if isSignedIn(); 
         allow write: if isAdmin();
    }
    
    // SECURITY & AUDIT
    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false; 
    }
    
    match /system_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    // NOTIFICATIONS
    match /users/{userId}/notifications/{notificationId} {
      allow read: if isSignedIn() && userId == uid();
      allow update: if isSignedIn() && userId == uid(); // Only for marking as read
      allow create: if isAdmin(); // Or server action
    }

    // CMS PAGES & CONFIG
    match /pages/{pageId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}

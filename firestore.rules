rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    function isSignedIn() { 
      return request.auth != null; 
    }
    
    function uid() { 
      return request.auth.uid; 
    }

    function isAdmin() {
      // Robust admin check: must have 'admin' role in user doc AND be active
      return isSignedIn()
        && get(/databases/$(database)/documents/users/$(uid())).data.role == 'admin'
        && get(/databases/$(database)/documents/users/$(uid())).data.isActive == true;
    }

    function isEnrolled(courseId) {
      // STRICT CHECK: Enrollment ID must be {uid}_{courseId}
      // This allows cheap 'exists' check instead of expensive query
      return exists(/databases/$(database)/documents/enrollments/$(uid() + '_' + courseId))
             && get(/databases/$(database)/documents/enrollments/$(uid() + '_' + courseId)).data.status == 'active';
    }

    function isTeam(courseId) {
      // Check if user is a member of the course team/staff
      return exists(/databases/$(database)/documents/courses/$(courseId)/team/$(uid()));
    }

    // --- Collections ---

    // USERS (Strict Privacy)
    match /users/{userId} {
      allow read: if isAdmin() || (isSignedIn() && userId == uid());
      // Updates strictly controlled via server actions or limited fields
      allow write: if isAdmin();
    }

    // COURSES (Catalog & Content)
    match /courses/{courseId} {
      // Read: Public/Open OR Enrolled OR Admin/Team
      allow read: if isAdmin() || isTeam(courseId) || isEnrolled(courseId) || resource.data.status == 'open'; 
      allow write: if isAdmin() || isTeam(courseId);

      // Subcollections inherit logic but specific rules apply
      match /modules/{moduleId} {
        allow read: if isAdmin() || isTeam(courseId) || isEnrolled(courseId);
        allow write: if isAdmin() || isTeam(courseId);
      }

      match /lessons/{lessonId} {
        allow read: if isAdmin() || isTeam(courseId) || isEnrolled(courseId);
        allow write: if isAdmin() || isTeam(courseId);

        match /blocks/{blockId} {
            allow read: if isAdmin() || isTeam(courseId) || isEnrolled(courseId);
            allow write: if isAdmin() || isTeam(courseId);
        }
      }

      match /materials/{materialId} {
        allow read: if isAdmin() || isTeam(courseId) || isEnrolled(courseId);
        allow write: if isAdmin() || isTeam(courseId);
      }

      match /announcements/{announcementId} {
        allow read: if isAdmin() || isTeam(courseId) || isEnrolled(courseId);
        allow write: if isAdmin() || isTeam(courseId);
      }

      // Community Subcollection (Preferred approach)
      match /communityThreads/{threadId} {
        allow read: if isAdmin() || isTeam(courseId) || isEnrolled(courseId);
        allow create: if isEnrolled(courseId);
        allow update: if (isAdmin() || isTeam(courseId)) || (isSignedIn() && request.resource.data.authorId == uid() && resource.data.authorId == uid() && !("isPinned" in request.resource.data) && !("isLocked" in request.resource.data));
        allow delete: if isAdmin() || isTeam(courseId); // Soft delete preferred via update

        match /replies/{replyId} {
          allow read: if isAdmin() || isTeam(courseId) || isEnrolled(courseId);
          allow create: if isEnrolled(courseId);
          allow update: if (isAdmin() || isTeam(courseId)) || (isSignedIn() && request.resource.data.authorId == uid());
          allow delete: if isAdmin() || isTeam(courseId);
        }
      }

      match /team/{memberId} {
        allow read: if isAdmin() || isTeam(courseId);
        allow write: if isAdmin() || isTeam(courseId);
      }
    }

    // GLOBAL ENROLLMENTS (The Ledger)
    match /enrollments/{enrollmentId} {
      // ID scheme: {uid}_{courseId}
      allow read: if isAdmin() || (isSignedIn() && resource.data.userId == uid());
      allow write: if isAdmin(); // System/Admin managed
    }

    // GLOBAL PROGRESS
    match /progress/{progressId} {
      // ID scheme: {uid}_{courseId} usually, or auto-id
      allow read: if isAdmin() || (isSignedIn() && resource.data.userId == uid()) || isTeam(resource.data.courseId);
      
      // Student can update their own progress
      allow create: if isSignedIn() && request.resource.data.userId == uid();
      allow update: if isSignedIn() && resource.data.userId == uid() && request.resource.data.userId == uid();
    }

    // GLOBAL CERTIFICATES
    match /certificates/{certificateId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.userId == uid());
      allow write: if isAdmin(); // Server issued
    }
    
    // EVENTS (Live Sessions)
    match /events/{eventId} {
         allow read: if isAdmin() || resource.data.isPublic == true || (resource.data.enrolledOnly == true && isEnrolled(resource.data.courseId));
         allow write: if isAdmin();
    }
    
    // SECURITY & AUDIT
    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false; 
    }
    
    match /system_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    // NOTIFICATIONS
    match /users/{userId}/notifications/{notificationId} {
      allow read: if isSignedIn() && userId == uid();
      allow update: if isSignedIn() && userId == uid(); // Only for marking as read
      allow create: if isAdmin(); // Or server action
    }
  }
}

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================
    // Helpers (expression-only)
    // =========================
    function isAuthenticated() {
      return request.auth != null;
    }

    function uid() {
      return request.auth.uid;
    }

    function isOwner(userId) {
      return isAuthenticated() && uid() == userId;
    }

    function isSuperAdminEmail() {
      return isAuthenticated()
        && (
          request.auth.token.email == 'liliangusmao@figuraviva.com'
          || request.auth.token.email == 'liliangusmao@institutofiguraviva.com.br'
        );
    }

    function isAdmin() {
      // Standard role/claim check OR hardcoded super admin email OR Firestore fallback
      return isAuthenticated() && (
        request.auth.token.admin == true
        || request.auth.token.role == 'admin'
        || isSuperAdminEmail()
        || get(/databases/$(database)/documents/users/$(uid())).data.role == 'admin'
      );
    }

    function courseRef(courseId) {
      return /databases/$(database)/documents/courses/$(courseId);
    }

    function isCourseOpenPublished(courseId) {
      return exists(courseRef(courseId))
        && get(courseRef(courseId)).data.isPublished == true
        && get(courseRef(courseId)).data.status == 'open';
    }

    function enrollmentRef(courseId) {
      // Canonical enrollment ID: {uid}_{courseId}
      return /databases/$(database)/documents/enrollments/$(uid() + '_' + courseId);
    }

    function isEnrolledActive(courseId) {
      return isAuthenticated()
        && exists(enrollmentRef(courseId))
        && get(enrollmentRef(courseId)).data.status == 'active';
    }

    function canReadCourseCatalog(courseId) {
      // catalog can be public for published/open
      return isCourseOpenPublished(courseId) || isAdmin();
    }

    function canReadCourseContent(courseId) {
      // content requires active enrollment + published/open course
      return (isCourseOpenPublished(courseId) && isEnrolledActive(courseId)) || isAdmin();
    }

    function isPublishedOrAdmin() {
      // STRICT: must be explicitly true
      return (resource.data.isPublished == true) || isAdmin();
    }

    // =========================
    // Courses (catalog) + Content (enrolled-only)
    // =========================
    match /courses/{courseId} {
      // Course doc (catalog)
      allow read: if (resource.data.isPublished == true && resource.data.status == 'open') || isAdmin();
      allow write: if isAdmin();

      // Modules (enrolled-only + published-only)
      match /modules/{moduleId} {
        allow read: if canReadCourseContent(courseId) && isPublishedOrAdmin();
        allow write: if isAdmin();

        // Lessons (enrolled-only + published-only)
        match /lessons/{lessonId} {
          allow read: if canReadCourseContent(courseId) && isPublishedOrAdmin();
          allow write: if isAdmin();

          // Optional materials
          match /materials/{materialId} {
            allow read: if canReadCourseContent(courseId) && isPublishedOrAdmin();
            allow write: if isAdmin();
          }
        }
      }

      // Community (enrolled-only)
      match /communityThreads/{threadId} {
        allow read, create: if canReadCourseContent(courseId);

        allow update: if canReadCourseContent(courseId)
          && (isAdmin() || resource.data.authorId == uid())
          && request.resource.data.authorId == resource.data.authorId;

        allow delete: if isAdmin() || (canReadCourseContent(courseId) && resource.data.authorId == uid());

        match /replies/{replyId} {
          allow read, create: if canReadCourseContent(courseId);

          allow update: if canReadCourseContent(courseId)
            && (isAdmin() || resource.data.authorId == uid())
            && request.resource.data.authorId == resource.data.authorId;

          allow delete: if isAdmin() || (canReadCourseContent(courseId) && resource.data.authorId == uid());
        }
      }

      // Announcements (enrolled-only)
      match /announcements/{annId} {
        allow read: if canReadCourseContent(courseId);
        allow write: if isAdmin();
      }
    }

    // =========================
    // Enrollments (SSoT) - admin/server writes only
    // =========================
    match /enrollments/{enrollmentId} {
      allow read: if isAuthenticated()
        && (
          isAdmin()
          || resource.data.userId == uid()
          || resource.data.uid == uid()
        );

      // client cannot write; admin/server only
      allow create, update, delete: if isAdmin();
    }

    // =========================
    // Progress (legacy) - admin/server writes only
    // =========================
    match /progress/{progressId} {
      allow read: if isAuthenticated()
        && (
          isAdmin()
          || resource.data.userId == uid()
          || resource.data.uid == uid()
        );

      allow create, update, delete: if isAdmin();
    }

    // =========================
    // Enrollment Requests (lead pipeline)
    // =========================
    match /enrollmentRequests/{requestId} {
      allow read: if isAuthenticated()
        && (
          isAdmin()
          || resource.data.uid == uid()
          || resource.data.userId == uid()
        );

      // Student creates idempotent request: {uid}_{courseId} with status 'new'
      allow create: if isAuthenticated()
        && request.resource.data.uid == uid()
        && requestId == uid() + '_' + request.resource.data.courseId
        && request.resource.data.status == 'new'
        && request.resource.data.createdAt <= request.time;

      // Student can only update phone/consent/updatedAt and cannot change status; admin can update anything
      allow update: if isAdmin()
        || (
          isAuthenticated()
          && resource.data.uid == uid()
          && request.resource.data.status == resource.data.status
          && request.resource.data.diff(resource.data).affectedKeys()
              .hasOnly(['phone', 'consentWhatsApp', 'updatedAt'])
        );

      allow delete: if isAdmin();
    }

    // =========================
    // Lesson Completions (server-only writes)
    // =========================
    match /lessonCompletions/{completionId} {
      allow read: if isAuthenticated() && (isAdmin() || resource.data.uid == uid());
      allow create, update, delete: if isAdmin();
    }

    // =========================
    // Lesson Watch (anti-skip telemetry) - monotonic updates
    // =========================
    match /lessonWatch/{watchId} {
      allow read: if isAuthenticated() && (isAdmin() || resource.data.uid == uid());

      allow create: if isAuthenticated()
        && request.resource.data.uid == uid()
        && request.resource.data.maxWatchedSeconds >= 0;

      allow update: if isAdmin()
        || (
          isAuthenticated()
          && resource.data.uid == uid()
          && request.resource.data.uid == resource.data.uid
          && request.resource.data.courseId == resource.data.courseId
          && request.resource.data.lessonId == resource.data.lessonId
          && request.resource.data.maxWatchedSeconds >= resource.data.maxWatchedSeconds
          && request.resource.data.diff(resource.data).affectedKeys()
              .hasOnly(['maxWatchedSeconds', 'durationSeconds', 'strictMode', 'updatedAt', 'uid', 'courseId', 'lessonId'])
        );

      allow delete: if isAdmin();
    }

    // =========================
    // Certificates (private) - admin/server writes
    // =========================
    match /certificates/{certId} {
      allow read: if isAuthenticated()
        && (
          isAdmin()
          || resource.data.userId == uid()
          || resource.data.uid == uid()
        );

      allow create, update, delete: if isAdmin();
    }

    // Public verification (minimal public payload only)
    match /certificatePublic/{certificateNumber} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // =========================
    // Users - protect role & isActive
    // =========================
    match /users/{userId} {
      // Admin can read all users (for enrollment manager); Owner can read own
      allow read: if isAdmin() || isOwner(userId);

      // Owner can create own profile but cannot create tutor/admin
      allow create: if isOwner(userId)
        && (
          !request.resource.data.keys().hasAny(['role'])
          || request.resource.data.role == 'student'
        )
        && (
          !request.resource.data.keys().hasAny(['isActive'])
          || request.resource.data.isActive == true
        );

      // Owner can update only safe fields; cannot change role/isActive
      allow update: if isAdmin()
        || (
          isOwner(userId)
          && (
            !resource.data.keys().hasAny(['role'])
            || request.resource.data.role == resource.data.role
          )
          && (
            !resource.data.keys().hasAny(['isActive'])
            || request.resource.data.isActive == resource.data.isActive
          )
          && request.resource.data.diff(resource.data).affectedKeys()
              .hasOnly(['displayName', 'phone', 'photoURL', 'updatedAt', 'consentWhatsApp'])
        );

      allow delete: if isAdmin();

      match /notifications/{notifId} {
        allow read: if isOwner(userId) || isAdmin();
        allow update: if (isOwner(userId) || isAdmin())
          && request.resource.data.diff(resource.data).affectedKeys()
              .hasOnly(['readAt', 'isRead', 'updatedAt']);
        allow create, delete: if isAdmin();
      }
    }

    // =========================
    // Content & Config Collections (Missing Rules)
    // =========================
    
    match /posts/{postId} {
      allow read: if isPublishedOrAdmin();
      allow write: if isAdmin();
    }

    match /gallery/{itemId} {
      allow read: if isPublishedOrAdmin();
      allow write: if isAdmin();
    }

    match /siteSettings/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /pages/{pageId} {
      // site content pages (founder, institute, config)
      allow read: if true; 
      allow write: if isAdmin();
    }

    match /team_members/{memberId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /publicDocs/{docId} {
      allow read: if isPublishedOrAdmin();
      allow write: if isAdmin();
    }

    // =========================
    // Events
    // =========================
    match /events/{eventId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // =========================
    // Applications (public lead form) - constrained payload
    // =========================
    match /applications/{appId} {
      allow create: if request.resource.data.keys()
        .hasOnly(['name', 'phone', 'email', 'message', 'createdAt', 'source'])
        && request.resource.data.createdAt <= request.time;

      allow read, update, delete: if isAdmin();
    }
  }
}

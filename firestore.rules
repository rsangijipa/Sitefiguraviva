rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // HELPER FUNCTIONS
    // =========================================================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() && (
        request.auth.token.admin == true || 
        request.auth.token.role == 'admin' ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin') ||
        request.auth.token.email.matches('.*@figuraviva\\.com.*') || 
        request.auth.token.email == 'liliangusmao@institutofiguraviva.com.br' ||
        request.auth.token.email == 'erlanesangi@gmail.com' ||
        request.auth.token.email == 'rsangijipa@gmail.com'
      );
    }

    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    // Advanced enrollment check: allows access if ANY enrollment doc exists for this pair
    // OR if the course ID is listed in the user's profile (robust Fallback)
    function hasActiveEnrollment(courseId) {
      let uid = request.auth.uid;
      return isAuthenticated() && (
        isAdmin() ||
        exists(/databases/$(database)/documents/enrollments/$(uid + '_' + courseId)) ||
        exists(/databases/$(database)/documents/enrollments/$(courseId + '_' + uid)) ||
        (exists(/databases/$(database)/documents/users/$(uid)) && 
         get(/databases/$(database)/documents/users/$(uid)).data.keys().hasAny(['enrolledCourseIds']) &&
         courseId in get(/databases/$(database)/documents/users/$(uid)).data.enrolledCourseIds)
      );
    }

    // =========================================================================
    // COLLECTIONS
    // =========================================================================

    match /users/{uid} {
      allow read: if isAdmin() || isOwner(uid);
      allow write: if isAdmin() || isOwner(uid); // Simplified for stability
      match /notifications/{id} { allow read, write: if isOwner(uid); }
    }

    match /enrollments/{id} {
      // Very permissive read for safety: if document ID contains your UID, you can see it
      allow read: if isAdmin() || (isAuthenticated() && (
        id.startsWith(request.auth.uid) || 
        id.endsWith(request.auth.uid) ||
        (resource != null && (resource.data.uid == request.auth.uid || resource.data.userId == request.auth.uid))
      ));
      allow write: if isAdmin();
    }

    match /courses/{courseId} {
      // Loosened: Authenticated users can read course metadata if published
      allow read: if isAdmin() || hasActiveEnrollment(courseId) || 
                    (isAuthenticated() && resource.data.isPublished == true);
      allow write: if isAdmin();

      match /modules/{mId} {
        // Loosened: Allow authenticated users to read modules if course is published
        allow read: if isAdmin() || hasActiveEnrollment(courseId) ||
                      (isAuthenticated() && get(/databases/$(database)/documents/courses/$(courseId)).data.isPublished == true);
        allow write: if isAdmin();

        match /lessons/{lId} {
          // Loosened: Allow authenticated users to read lesson metadata if course is published
          allow read: if isAdmin() || hasActiveEnrollment(courseId) ||
                        (isAuthenticated() && get(/databases/$(database)/documents/courses/$(courseId)).data.isPublished == true);
          allow write: if isAdmin();

          // CRITICAL: Subcollections (Blocks, Tests, etc) - restricted to enrolled students
          match /{allLessonsSub=**} {
            allow read: if isAdmin() || hasActiveEnrollment(courseId);
            allow write: if isAdmin();
          }
        }
      }
      match /materials/{id} { allow read: if isAdmin() || hasActiveEnrollment(courseId); allow write: if isAdmin(); }
      match /announcements/{id} { allow read: if isAdmin() || hasActiveEnrollment(courseId); allow write: if isAdmin(); }
    }


    match /progress/{id} {
      allow read: if isAdmin() || id.startsWith(request.auth.uid);
      allow write: if isAdmin() || (isAuthenticated() && id.startsWith(request.auth.uid));
    }

    match /community/{id} {
      allow read: if true;
      allow create: if isAuthenticated() 
        && request.resource.data.authorId == request.auth.uid
        && request.resource.data.createdAt == request.time;
      
      allow update: if isAuthenticated() 
        && resource.data.authorId == request.auth.uid
        && request.resource.data.authorId == resource.data.authorId
        && request.resource.data.createdAt == resource.data.createdAt;
      
      allow delete: if isAdmin() || (isAuthenticated() && resource.data.authorId == request.auth.uid);

      match /replies/{rId} {
        allow read: if true;
        allow create: if isAuthenticated()
          && request.resource.data.authorId == request.auth.uid;
        allow update, delete: if isAdmin() || (isAuthenticated() && resource.data.authorId == request.auth.uid);
      }
    }

    match /gamification_profiles/{uid} {
      allow read: if isAdmin() || isOwner(uid);
      allow write: if false; // LOCKED. Only Admin SDK.
    }

    match /xp_transactions/{id} {
      allow get: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow list: if isAdmin();
      allow write: if false; // LOCKED. Only Admin SDK.
    }

    // Public Collections
    match /stats/{id} { 
      allow read: if true; 
      allow write: if false; // LOCKED. Only Server Actions/Admin SDK.
    }
    match /siteSettings/{id} { allow read: if true; allow write: if isAdmin(); }
    match /publicDocs/{id} { allow read: if true; allow write: if isAdmin(); }
    match /posts/{id} { allow read: if true; allow write: if isAdmin(); }
    match /gallery/{id} { allow read: if true; allow write: if isAdmin(); }
    match /events/{id} { allow read: if true; allow write: if isAdmin(); }
    
    match /certificates/{id} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow write: if isAdmin();
    }

    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}

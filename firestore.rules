rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // HELPER FUNCTIONS
    // =========================================================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isAdmin() {
      return isAuthenticated() && (
        request.auth.token.admin == true || 
        (request.auth.token.role != null && request.auth.token.role.lower() == 'admin') ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         getUserDoc().get('role', 'student').lower() in ['admin', 'administrador'] &&
         getUserDoc().get('isActive', true) == true)
      );
    }

    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    // Check if course is globally blocked (archived or unpublished)
    function isCourseBlocked(courseId) {
      return exists(/databases/$(database)/documents/courses/$(courseId)) &&
             get(/databases/$(database)/documents/courses/$(courseId)).data.status == 'archived';
    }

    // Advanced enrollment check: allows access if enrollment exists with correct status
    function hasActiveEnrollment(courseId) {
      let uid = request.auth.uid;
      let enrollmentId = uid + '_' + courseId;
      
      return isAuthenticated() && (
        isAdmin() ||
        // Check standard deterministic ID format
        (exists(/databases/$(database)/documents/enrollments/$(enrollmentId)) &&
         get(/databases/$(database)/documents/enrollments/$(enrollmentId)).data.status in ['active', 'completed']) ||
        // Fallback for transition/legacy Check
        (exists(/databases/$(database)/documents/users/$(uid)) && 
         courseId in getUserDoc().get('enrolledCourseIds', []))
      );
    }

    // =========================================================================
    // COLLECTIONS
    // =========================================================================

    match /users/{uid} {
      allow read: if isAdmin() || isOwner(uid);
      // Only admins can change roles/isActive. Users can update other fields.
      allow create: if isAdmin() || isOwner(uid);
      allow update: if isAdmin() || (isOwner(uid) && 
                      !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'isActive', 'uid', 'email']));
      
      match /notifications/{id} { allow read, write: if isOwner(uid); }
    }

    match /enrollments/{id} {
      allow read: if isAdmin() || (isAuthenticated() && (
        id.startsWith(request.auth.uid) || 
        id.endsWith(request.auth.uid) ||
        resource.data.uid == request.auth.uid
      ));
      allow write: if isAdmin();
    }

    match /courses/{courseId} {
      allow read: if isAdmin() || hasActiveEnrollment(courseId) || 
                    (resource != null && resource.data.isPublished == true);
      allow write: if isAdmin();

      match /modules/{mId} {
        allow read: if isAdmin() || 
                      (hasActiveEnrollment(courseId) && !isCourseBlocked(courseId)) ||
                      (get(/databases/$(database)/documents/courses/$(courseId)).data.isPublished == true);
        allow write: if isAdmin();

        match /lessons/{lId} {
          allow read: if isAdmin() || 
                        (hasActiveEnrollment(courseId) && !isCourseBlocked(courseId)) ||
                        (get(/databases/$(database)/documents/courses/$(courseId)).data.isPublished == true);
          allow write: if isAdmin();

          match /{allLessonsSub=**} {
            allow read: if isAdmin() || 
                          (hasActiveEnrollment(courseId) && !isCourseBlocked(courseId));
            allow write: if isAdmin();
          }
        }
      }
      match /materials/{id} { 
        allow read: if isAdmin() || (hasActiveEnrollment(courseId) && !isCourseBlocked(courseId)); 
        allow write: if isAdmin(); 
      }
      match /announcements/{id} { allow read: if isAdmin() || hasActiveEnrollment(courseId); allow write: if isAdmin(); }
      
      match /communityThreads/{threadId} {
        allow read: if isAdmin() || hasActiveEnrollment(courseId);
        allow create: if isAdmin() || (hasActiveEnrollment(courseId) && request.resource.data.authorId == request.auth.uid);
        allow update, delete: if isAdmin() || (isAuthenticated() && resource.data.authorId == request.auth.uid);

        match /replies/{replyId} {
          allow read: if isAdmin() || hasActiveEnrollment(courseId);
          allow create: if isAdmin() || (hasActiveEnrollment(courseId) && request.resource.data.authorId == request.auth.uid);
          allow update, delete: if isAdmin() || (isAuthenticated() && resource.data.authorId == request.auth.uid);
        }
      }
    }

    match /progress/{id} {
      allow read: if isAdmin() || id.startsWith(request.auth.uid);
      allow write: if isAdmin() || (isAuthenticated() && id.startsWith(request.auth.uid));
    }

    match /community_threads/{id} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.authorId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.authorId == request.auth.uid;
      allow delete: if isAdmin() || (isAuthenticated() && resource.data.authorId == request.auth.uid);

      match /replies/{rId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && request.resource.data.authorId == request.auth.uid;
        allow update, delete: if isAdmin() || (isAuthenticated() && resource.data.authorId == request.auth.uid);
      }
    }

    match /gamification_profiles/{uid} {
      allow read: if isAdmin() || isOwner(uid);
      allow write: if false; // LOCKED. Only Admin SDK.
    }

    match /xp_transactions/{id} {
      allow get: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow list: if isAdmin();
      allow write: if false; // LOCKED. Only Admin SDK.
    }

    // Public Collections
    match /stats/{id} { allow read: if true; allow write: if false; }
    match /siteSettings/{id} { allow read: if true; allow write: if isAdmin(); }
    match /publicDocs/{id} { allow read: if true; allow write: if isAdmin(); }
    match /posts/{id} { allow read: if true; allow write: if isAdmin(); }
    match /gallery/{id} { allow read: if true; allow write: if isAdmin(); }
    match /events/{id} { allow read: if true; allow write: if isAdmin(); }
    match /publicLibrary/{id} { allow read: if true; allow write: if isAdmin(); }
    match /publicGallery/{id} { allow read: if true; allow write: if isAdmin(); }
    
    match /certificates/{id} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow write: if isAdmin();
    }

    match /{document=**} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
  }
}
